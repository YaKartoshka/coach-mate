<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile</title>
    <link rel="shortcut icon" href="../public/images/Favicon.png" type="image/x-icon">
    <%- include('./components/head.ejs.html') %>
</head>

<body>
    <header>
        <div class="logo">
            <a href="/"><img src="/public/images/CoachMate.png" alt=""></a>
        </div>
        <%- include('./components/profile_bar.ejs.html') %>
    </header>
    <main>
        <%- include('./components/nav_bar.ejs.html') %>

            <div class="settings-content">
                <div class="tab-switcher">
                    <div class="profile-tab active">PROFILE</div>
                    <div class="password-tab">PASSWORD</div>
                </div>


                <div class="tab-content">
                    <div class="profile-content active">


                        <div class="profile_header">
                            <div class="profile-image-settings">
                                <div class="photo">
                                    <img src="" class="rounded-circle" alt="" id="profile_img" width="150">
                                </div>

                                <div class="profile_photo mb-3 mt-2">
                                    <label class="mb-3">
                                        <input type="file" class="form-control file-button" id="profile_img_src"
                                            placeholder="Change photo">
                                    </label>
                                </div>
                            </div>

                            <!-- <div class="panel-name mb-3 mt-4">
                                <label class="mb-2">Panel name</label>
                                <input type="text" class="form-control" id="panel_name" placeholder="Your panel name">
                            </div> -->
                        </div>

                        <div class="personal-info">
                            <form autocomplete="off">
                                <div class="mb-3 mt-5">
                                    <p>Personal info</p>
                                </div>

                                <div class="main-info">
                                    <div class="fname-lname">
                                        <div class="fname mb-3 mt-3">
                                            <label class="mb-2">First name</label>
                                            <input type="text" class="form-control" id="first_name" placeholder="Toji"
                                                required>
                                        </div>
                                        <div class="lname mb-3 mt-3">
                                            <label class="mb-2">Last name</label>
                                            <input type="text" class="form-control" id="last_name"
                                                placeholder="Fushiguro" required>
                                        </div>
                                    </div>
                                    <div class="email-phone">
                                        <div class="email mb-3 mt-3">
                                            <label class="mb-2">Email</label>
                                            <input type="text" class="form-control" id="email"
                                                placeholder="example@gmail.com" disabled>
                                        </div>
                                        <div class="phone-number mb-3 mt-3">
                                            <label class="mb-2">Phone number</label>
                                            <input type="text" class="form-control" id="phone_number" placeholder="+7">
                                        </div>
                                    </div>
                                </div>

                                <div class="about mb-3 mt-4">
                                    <label class="mb-2">About me</label>
                                    <textarea id="description" cols="30" rows="7" class="form-control"></textarea>
                                </div>
                            </form>
                        </div>


                        <div class="profile-footer">
                            <div class="save-btn">
                                <button type="button" id="change_profile_btn" class="btn btn-outline-primary"
                                    onclick="changeProfile()"> Save changes</button>
                            </div>

                            <div class="box-important">
                                <img src="../public/images/box Important.svg" alt="">
                                <span>Personalize your profile to provide your colleagues with a deeper understanding of
                                    who you
                                    are. Remember to include a photo as well!</span>
                            </div>
                        </div>
                    </div>
                    <div class="password-content">
                        <div class="password-header">
                            <div class="box-important">
                                <img src="../public/images/password.svg" alt="">
                                <span>Personalize your profile to provide your colleagues with a deeper understanding of
                                    who you are. Remember to include a photo as well!</span>
                            </div>
                        </div>

                        <div class="password-body">
                            <div class="newpass-confirmpass">
                                <div class="new-password mb-3 mt-5">
                                    <label class="mb-2">New password</label>
                                    <input type="password" class="form-control" id="new_password" placeholder="1234567"
                                        oninput="updateStrengthIndicator()">
                                    <div id="password-validation" class="invalid-feedback"></div>
                                </div>
                                <div class="confirm-password mb-3 mt-5">
                                    <label class="mb-2">Confirm new password</label>
                                    <input type="password" class="form-control" id="confirm_password"
                                        placeholder="1234567">
                                    <div class="valid-feedback">Passwords match.</div>
                                    <div class="invalid-feedback">Please confirm your password.</div>
                                </div>
                            </div>


                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="showPasswordCheckbox">
                                <label class="form-check-label show-pass" for="showPasswordCheckbox">Show
                                    password</label>
                            </div>
                        </div>

                        <div class="password-footer">
                            <div class="save-btn">
                                <button type="button" class="btn btn-outline-primary" id="change_password_btn"
                                    onclick="changePassword()"> Save
                                    changes</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <%- include('./components/links_bar.ejs.html') %>   
    </main>


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        $(document).ready(function () {
            loading(1);
            showProfile();
            loading(0);
        });

        $('#profile-data').on('click', () => {
            $('.dropdown-content').slideToggle(300);
        });

        $(document).ready(function () {
            var currentUrl = window.location.pathname;
            $(".nav-bar ul li").each(function () {
                var listItem = $(this);
                var listItemLink = listItem.find("a");
                var listItemHref = listItemLink.attr("href");

                if (currentUrl === listItemHref) {
                    listItem.addClass("active");
                } else {
                    listItem.removeClass("active");
                }
            });
        });

        $(document).ready(function () {
            var tabs = $(".tab-switcher > div");
            var tabContents = $(".tab-content > div");

            tabs.each(function (index) {
                $(this).click(function () {

                    tabs.removeClass("active");
                    tabContents.removeClass("active");

                    $(this).addClass("active");
                    tabContents.eq(index).addClass("active");
                });
            });
            tabs.first().click();
        });

        $(document).ready(function () {
            $('#showPasswordCheckbox').change(function () {
                const newPasswordInput = $('#new_password');
                const confirmPasswordInput = $('#confirm_password');

                if ($(this).is(':checked')) {
                    newPasswordInput.attr('type', 'text');
                    confirmPasswordInput.attr('type', 'text');
                } else {
                    newPasswordInput.attr('type', 'password');
                    confirmPasswordInput.attr('type', 'password');
                }
            });
        });

        function showProfile() {
            $.ajax({
                url: '/users/get', method: 'get', success: function (data) {
                    var user = JSON.parse(data);
                    $("#first_name").val(user.first_name);
                    $("#last_name").val(user.last_name);
                    $("#email").val(user.email);
                    $("#description").val(user.description);
                    $("#phone_number").val(user.phone_number);

                    let profile_src = !user.profile_img ? "./public/images/user_avatar.png" : user.profile_img;
                    $('#profile_img').attr('src', profile_src)
                }, error: function (err) {
                    console.log(err);
                }
            });
        }

        function changeProfile() {
            loading(2, el = '#change_profile_btn');
            let img = $('#profile_img_src')[0].files[0];
            console.log(img)
            let first_name = $('#first_name').val().trim();
            let last_name = $('#last_name').val().trim();
            let phone_number = $('#phone_number').val().trim();
            let description = $('#description').val().trim();
            let profile_img_src = null;
            if (!first_name || !last_name) {
                if (!first_name) $('#first_name').focus();
                if (!last_name) $('#last_name').focus();
                $.ambiance({
                    message: "Fill in required fields",
                    type: "error",
                    fade: true,
                    width: 400
                });
                return loading(20, el = '#change_profile_btn');;
            }

            if (first_name.length > 20 || last_name.length > 20) {
                if (first_name.length > 20) $('#first_name').focus();
                if (last_name.length > 20) $('#last_name').focus();
                $.ambiance({
                    message: "The length of the first and last name should be no more than 20",
                    type: "error",
                    fade: true,
                    width: 400
                });
                return loading(20, el = '#change_profile_btn');
            }

            if (!img || img == undefined) {
                profile_img_src = $('#profile_img').attr('src')
                if (profile_img_src == './public/images/user_avatar.png') {
                    profile_img_src = null;
                    img = null;
                }
            }
            let formData = new FormData();
            formData.append('img', img);
            formData.append('first_name', first_name);
            formData.append('last_name', last_name);
            formData.append('phone_number', phone_number);
            formData.append('description', description);
            formData.append('profile_img_src', profile_img_src);

            $.ajax({
                url: '/profile/update',
                method: 'post',
                data: formData,
                processData: false,
                contentType: false,
                success: function (r) {
                    var res = JSON.parse(r);
                    if (res.r) {
                        $.ambiance({
                            message: "Your profile updated",
                            type: "success",
                            fade: true,
                            width: 400
                        });
                    }
                    return loading(20, el = '#change_profile_btn');
                }, error: function (err) {
                    console.log(err);
                    $.ambiance({
                        message: "Something went wrong. Try again later",
                        type: "success",
                        fade: true,
                        width: 400
                    });
                    return loading(20, el = '#change_profile_btn');
                }
            });
        }

        const STRENGTH_STRONG = 9;
        const STRENGTH_MODERATE = 6;

        function changePassword() {
            const new_password = $('#new_password').val().trim();
            const confirm_password = $('#confirm_password').val().trim();

            if (!new_password || !confirm_password) {
                showError('Please enter both new and confirm passwords');
                return;
            }

            if (new_password !== confirm_password) {
                showError('Passwords do not match!');
                return;
            }

            if (!isPasswordComplex(new_password)) {
                return;
            }

            $.ajax({
                url: '/profile/change_password',
                method: 'post',
                data: { password: new_password },
                success: function (r) {
                    const res = JSON.parse(r);
                    if (res.r) {
                        showSuccess('Password changed successfully!');
                        $('#new_password, #confirm_password').val('');
                        resetStrengthIndicator();
                    }
                },
                error: function (err) {
                    console.log(err);
                    showError('Failed to change password. Please try again later.');
                }
            });
        }

        function isPasswordComplex(password) {
            const hasLowercase = /[a-z]/.test(password);
            const hasUppercase = /[A-Z]/.test(password);
            const hasDigit = /\d/.test(password);
            const hasSpecialChar = /[!@#$%^&*(),.?":{}|<>]/.test(password);

            if (password.length < 6) {
                showError('Password should be at least 6 characters long');
                return false;
            }

            if (!hasUppercase) {
                showError('Password should contain at least one uppercase letter');
                return false;
            }

            if (!hasSpecialChar) {
                showError('Password should contain at least one special character');
                return false;
            }

            return true;
        }

        function showError(message) {
            showMessage(message, 'error');
        }

        function showSuccess(message) {
            showMessage(message, 'success');
        }

        function showMessage(message, type) {
            $.ambiance({
                message: message,
                type: type,
                width: 400,
                fade: true
            });
        }

        function calculatePasswordStrength(password) {
            const conditions = [/[a-z]/, /[A-Z]/, /\d/, /[!@#$%^&*(),.?":{}|<>]/];
            const conditionsMet = conditions.reduce((count, condition) => count + condition.test(password), 0);

            return conditionsMet === 4 ? STRENGTH_STRONG : (conditionsMet >= 2 ? STRENGTH_MODERATE : 0);
        }

        function updateStrengthIndicator() {
            const newPasswordInput = $('#new_password');
            const passwordValidationMessage = $('#password-validation');
            const password = newPasswordInput.val().trim();
            const strength = calculatePasswordStrength(password);

            const classes = ['border-danger', 'border-warning', 'border-success'];
            newPasswordInput.removeClass(classes.join(' '));
            passwordValidationMessage.removeClass(classes.map(c => `text-${c.replace('border-', '')}`).join(' '));

            const colors = {
                [STRENGTH_STRONG]: { class: 'success', color: 'rgba(40, 167, 69, 0.25)' },
                [STRENGTH_MODERATE]: { class: 'warning', color: 'rgba(255, 193, 7, 0.25)' },
                0: { class: 'danger', color: 'rgba(220, 53, 69, 0.25)' }
            };

            newPasswordInput.addClass(`border-${colors[strength].class}`);
            newPasswordInput.css('box-shadow', `0 0 0 0.25rem ${colors[strength].color}`);
            passwordValidationMessage.addClass(`text-${colors[strength].class}`);

            passwordValidationMessage.text(`Password is ${strength ? (strength === STRENGTH_STRONG ? 'strong' : 'moderate') : 'weak'}.`);
        }

        function resetStrengthIndicator() {
            $('#password-validation').text('').removeClass('text-danger text-warning text-success');
        }

        $('#new_password').on('input', updateStrengthIndicator);

        function validatePassword() {
            const newPassword = $('#new_password').val();
            const validationMessage = $('#password-validation');

            if (newPassword.length < 6) {
                validationMessage.text('Password should be at least 6 characters long.').removeClass('text-success').addClass('text-danger');
                return false;
            }

            const hasSpecialChar = /[!@#$%^&*(),.?":{}|<>]/.test(newPassword);

            if (!hasSpecialChar) {
                validationMessage.text('Password should contain at least one special character.').removeClass('text-success').addClass('text-danger');
                return false;
            }

            validationMessage.text('Password is valid.').removeClass('text-danger').addClass('text-success');
            return true;
        }

    </script>

</body>

</html>